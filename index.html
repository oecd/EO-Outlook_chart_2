<doctype HTML>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <head>

        <link
            href="https://fonts.googleapis.com/css?family=Noto+Sans:400,400i,700,700i|Oswald:200,300,400,500,600,700&display=swap&subset=latin-ext"
            rel="stylesheet">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/site.css">
        <script src="https://code.jquery.com/jquery-3.5.0.js"
            integrity="sha256-r/AaFHrszJtwpe+tHyNi/XCfMxYpbsRg2Uqn0x3s2zc=" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

        <script src="libs/d3.v4.min.js"></script>
        <script src="libs/d3.v4.jetpack.min.js"></script>
        <script src="libs/d3-scale-chromatic.v1.min.js"></script>
        <script src="libs/topojson.v1.min.js"></script>
        <script src="libs/d3-queue.v3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
         <link rel="icon" href="img/favicon.ico">
 
    </head>

    <body>
    <h1>A collapse in output followed by a slow recovery</h1>
    <h2>World GDP, index 2019-Q4=100</h2>
    <div id="scenario" alt=""></div>

    <script type="text/javascript">

        var startChart = "2018-Q1";
        var startForecast = "2019-Q4";
        var annotationMark=[];


    var allScenario;
    

    var divMap = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    var color = ["#E73741", "#0F8FD9", "#993484", "#DF521E", "#719E24"];

    var margin = { top: 70, right: 50, bottom: 30, left: 80 };

    var mapRatio = 8 / 20;

    var width = document.getElementById("scenario").offsetWidth - margin.left - margin.right;

    var height;
    if (width > 650)
        height = width * mapRatio;
    else
        height = width;


    var urls = {
        scenario: "data/data.tsv"
        
    };

    d3.queue()
        .defer(d3.tsv, urls.scenario)
        .await(render);



    var scenarioSVG = d3.select("#scenario").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    // Add X axis --> it is a date format
    var x = d3.scaleLinear()
        .range([0, width]);

    function dateParser(d) {
        var splitted = d.split('-');
        var quarterEndMonth = splitted[1].charAt(1) * 3;
        var quarterStartMonth = quarterEndMonth - 3;

        return d3.timeParse('%m-%Y')(quarterStartMonth + '-' + splitted[0]);
    }


    var bisectDate = d3.bisector(function (d) { return dateParser(d.TIME); }).left;
    //Add Y axis
    var y = d3.scaleLinear() //or scaleLog
        .range([height, 0]);




    function render(err, scenarioData) {
        allScenario = scenarioData;
        annotationMark= scenarioData.filter(function (d) { return d.TIME == "2021-Q1"; });
         console.log(annotationMark)

        updateChart();


    }

    function updateChart() {
        scenarioSVG.selectAll("*").remove()

        x.domain(d3.extent(allScenario, function (d) { return dateParser(d.TIME); }))
        y.domain([d3.min(allScenario, function (d) { return d3.min([parseFloat(d.forecast2019), parseFloat(d.singleHit), parseFloat(d.doubleHit)]); }), d3.max(allScenario, function (d) { return d3.max([parseFloat(d.forecast2019), parseFloat(d.singleHit), parseFloat(d.doubleHit)]); })])


        scenarioSVG
            .append("g")
            .attr("class", "axisContext")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).ticks(6)
                .tickFormat(function (x) {
                    // get the milliseconds since Epoch for the date
                    var milli = (x + 7884000000);

                    // calculate new date 10 seconds earlier. Could be one second, 
                    // but I like a little buffer for my neuroses
                    var vanilli = new Date(milli);

                    // calculate the month (0-11) based on the new date
                    var mon = vanilli.getMonth();
                    var yr = vanilli.getFullYear();

                    // return appropriate quarter for that month
                    if (mon <= 2) {
                        return "Q1 -" + yr;
                    } else if (mon <= 5) {
                        return "Q2 - " + yr;
                    } else if (mon <= 8) {
                        return "Q3 - " + yr;
                    } else {
                        return "Q4 - " + yr;
                    }
                }));

        scenarioSVG.append("g")
            .attr("class", "axisContext")
            .call(d3.axisLeft(y).tickFormat(function (d) {
                return y.tickFormat(10, d3.format(".1f"))(d)
            }).tickSize(-(width)));


        function tweenDash() {
            var l = this.getTotalLength(),
                i = d3.interpolateString("0," + l, l + "," + l);
            return function (t) { return i(t); };
        }

        // Draw the line
        scenarioSVG
            .append("path")
            .attr("fill", "none"/*"#8DCD79"*/)
            .attr("stroke", function (d) { return color[0] })
            .attr("stroke-width","4px")
           // .attr("opacity", function () { if (k == 0) return 0.1; else return 1; })
            .attr("class", "lineContext")
            //.attr("id", function (d) { return "doubleHit" + i; })
            .attr("d", function (d) {
                return d3.line()//area
                    .x(function (d) { return x(dateParser(d.TIME)); })
                    // .y0(y(0))
                    .y(function (d) { return y(parseFloat(d.forecast2019)); })
                    (allScenario.filter(function (d) { return dateParser(d.TIME) <= dateParser(startForecast); }))
            })
            .transition()
            .duration(3000)
            .attrTween("stroke-dasharray", tweenDash)
            .on("end", drawforecast)

        
        scenarioSVG.append("text")
            .attr("x", function (d) { return x(dateParser("2019-Q1")) +30 })
            .attr("y", function (d) { height })
            .attr("class", "explanatory")
            .text("This is the quartely evolution of the World GDP in 2019")
            .transition().delay(2700).remove()


        // Draw forecast
        function drawforecast(){             
        scenarioSVG
            .append("path")
            .attr("fill", "none")
            .attr("stroke", function (d) { return color[0] })
            .attr("stroke-width", "4px")
            .attr("opacity",0.5)
            .attr("d", function (d) {
                return d3.line()//area
                    .x(function (d) { return x(dateParser(d.TIME)); })
                    // .y0(y(0))
                    .y(function (d) { return y(parseFloat(d.forecast2019)); })
                    (allScenario.filter(function (d) { return dateParser(d.TIME) >= dateParser(startForecast); }))
            })
            .transition()
            .duration(8000)
            .attrTween("stroke-dasharray", tweenDash)

            scenarioSVG
                .append("path")
                .attr("fill", "none")
                .attr("stroke-width", "4px")
                .attr("class","forecast")
                .transition().delay(7500)
                .attr("d", function (d) {
                    return d3.line()//area
                        .x(function (d) { return x(dateParser(d.TIME)); })
                        // .y0(y(0))
                        .y(function (d) { return y(parseFloat(d.forecast2019)); })
                        (allScenario.filter(function (d) { return dateParser(d.TIME) >= dateParser(startForecast); }))
                })
                .on("end", drawScenario1)
            
            scenarioSVG.append("text")
                .attr("x", function (d) { return x(dateParser("2019-Q1")) +30 })
                .attr("y", function (d) { height })
                .attr("class", "explanatory")
                .transition().duration(500)
                .text("and how - back in November 2019 - we estimated it would grow")
                .transition().delay(3000).duration(200).remove()

            scenarioSVG.append("text")
                .attr("x", function (d) { return x(dateParser("2019-Q1")) +30 })
                .attr("y", function (d) { height })
                .attr("class", "explanatory")
                .transition().delay(4000).duration(500)
                .text("The Covid-19 crisis led us to drastically revise our forecasts")
                .transition().delay(3000).duration(200).remove()
        }

        function drawScenario1(){
            scenarioSVG
                .append("path")
                .attr("fill", "none")
                .attr("stroke", function (d) { return color[1] })
                .attr("stroke-width", "4px")
                .attr("d", function (d) {
                    return d3.line()//area
                        .x(function (d) { return x(dateParser(d.TIME)); })
                        // .y0(y(0))
                        .y(function (d) { return y(parseFloat(d.singleHit)); })
                        (allScenario.filter(function (d) { return dateParser(d.TIME) >= dateParser(startForecast); }))
                })
                .transition()
                .duration(7000)
                .attrTween("stroke-dasharray", tweenDash)

            scenarioSVG
                .append("path")
                .attr("fill", "none")
                .attr("stroke-width", "4px")
                .attr("class", "forecast")
                .transition().delay(6500)
                .attr("d", function (d) {
                    return d3.line()//area
                        .x(function (d) { return x(dateParser(d.TIME)); })
                        // .y0(y(0))
                        .y(function (d) { return y(parseFloat(d.singleHit)); })
                        (allScenario.filter(function (d) { return dateParser(d.TIME) >= dateParser(startForecast); }))
                })
                .on("end", drawScenario2)
            
            scenarioSVG.append("text")
                .attr("x", function (d) { return x(dateParser("2019-Q1")) +30 })
                .attr("y", function (d) { height })
                .attr("class", "explanatory")
                .transition().duration(500)
                .text("the blue line shows our forecasts with one Covid-19 crisis")
                .transition().delay(6000).duration(200).remove()

        } 


        function drawScenario2(){

            scenarioSVG
                .append("path")
                .attr("fill", "none")
                .attr("stroke", function (d) { return color[2] })
                .attr("stroke-width", "4px")
                .attr("d", function (d) {
                    return d3.line()//area
                        .x(function (d) { return x(dateParser(d.TIME)); })
                        // .y0(y(0))
                        .y(function (d) { return y(parseFloat(d.doubleHit)); })
                        (allScenario.filter(function (d) { return dateParser(d.TIME) >= dateParser(startForecast); }))
                })
                .transition()
                .duration(8000)
                .attrTween("stroke-dasharray", tweenDash)

            scenarioSVG
                .append("path")
                .attr("fill", "none")
                .attr("stroke-width", "4px")
                .attr("class", "forecast")
                .transition().delay(7500)
                .attr("d", function (d) {
                    return d3.line()//area
                        .x(function (d) { return x(dateParser(d.TIME)); })
                        // .y0(y(0))
                        .y(function (d) { return y(parseFloat(d.doubleHit)); })
                        (allScenario.filter(function (d) { return dateParser(d.TIME) >= dateParser(startForecast); }))
                })
                .on("end", annotate)
            
            scenarioSVG.append("text")
                .attr("x", function (d) { return x(dateParser("2019-Q1")) +30 })
                .attr("y", function (d) { height })
                .attr("class", "explanatory")
                .transition().duration(500)
                .text("the purple line shows forecasts with a Covid-19 rebound in the fall")
                .transition().delay(7000).duration(200).remove()

            }
        

        function annotate(){
          // Features of the annotation
            const annotation2019 = [
                {
                    note: {
                        label: "November 2019 forecasts"
                    },
                    x: x(dateParser("2021-Q1")),
                    y: y(annotationMark[0].forecast2019),
                    dy: 50,
                    dx: 50
                }
            ]
            const annotationSingle = [
                {
                    note: {
                        label: "Single-hit scenario"
                        
                    },
                    x: x(dateParser("2021-Q1")),
                    y: y(annotationMark[0].singleHit),
                    dy: -50,
                    dx: -50
                }
            ]
            const annotationDouble = [
                {
                    note: {
                        label: "Double-hit scenario"
                    },
                    x: x(dateParser("2021-Q1")),
                    y: y(annotationMark[0].doubleHit),
                    dy: 50,
                    dx: 50
                }
            ]
            // Add annotation to the chart
            const makeAnnotation2019 = d3.annotation()
                .annotations(annotation2019)
            scenarioSVG
                .append("g")
                .call(makeAnnotation2019)

            // Add annotation to the chart
            const makeAnnotationSingle = d3.annotation()
                .annotations(annotationSingle)
            scenarioSVG
                .append("g")
                .call(makeAnnotationSingle)

            // Add annotation to the chart
            const makeAnnotationDouble = d3.annotation()
                .annotations(annotationDouble)
            scenarioSVG
                .append("g")
                .call(makeAnnotationDouble)


            scenarioSVG.append("text")
                .attr("x", function (d) { return x(dateParser("2019-Q1")) +30 })
                .attr("y", function (d) { height })
                .attr("class", "explanatory")
                .transition().duration(500)
                .text("In both scenarios, we won't be back at 2019-Q4 level before at least 2 years")

        }
    }
 </script>

</body>